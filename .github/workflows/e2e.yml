# .github/workflows/e2e.yml â€” Dedicated E2E test workflow
#
# Runs comprehensive E2E tests (CLI + Web) with log aggregation,
# HTML reports, and artifact upload. Triggered on push/PR to main,
# or manually via workflow_dispatch.
#
# The run-e2e.sh script orchestrates:
#   1. CLI E2E tests (bun test)
#   2. Web E2E tests (Playwright, matrix: chromium + Mobile Chrome)
#   3. JSONL log aggregation into a single report
#   4. HTML summary generation

name: E2E Tests

on:
  push:
    branches: [main]
    paths:
      - 'apps/web/**'
      - 'packages/**'
      - 'e2e/**'
      - 'scripts/run-e2e.sh'
      - '.github/workflows/e2e.yml'
  pull_request:
    branches: [main]
    paths:
      - 'apps/web/**'
      - 'packages/**'
      - 'e2e/**'
      - 'scripts/run-e2e.sh'
      - '.github/workflows/e2e.yml'
  workflow_dispatch:
    inputs:
      project:
        description: 'Playwright project (chromium, Mobile Chrome, firefox, webkit)'
        required: false
        default: 'chromium'
      retries:
        description: 'Number of retries per test'
        required: false
        default: '2'

env:
  BUN_VERSION: '1.2'
  CI: 'true'

jobs:
  e2e-cli:
    name: CLI E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run CLI E2E tests
        run: ./scripts/run-e2e.sh --skip-web --verbose
        env:
          E2E_REPORT_DIR: e2e-report-cli

      - name: Upload CLI E2E report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-report-cli
          path: e2e-report-cli/
          retention-days: 14

  e2e-web:
    name: Web E2E (${{ matrix.project }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        project: [chromium, 'Mobile Chrome']
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: pw-${{ runner.os }}-${{ matrix.project }}-${{ hashFiles('apps/web/package.json') }}
          restore-keys: pw-${{ runner.os }}-${{ matrix.project }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium

      - name: Run Web E2E tests
        run: |
          ./scripts/run-e2e.sh \
            --skip-cli \
            --project "${{ matrix.project }}" \
            --retries "${{ github.event.inputs.retries || '2' }}" \
            --start-server
        env:
          E2E_REPORT_DIR: e2e-report-web-${{ matrix.project == 'Mobile Chrome' && 'mobile' || 'desktop' }}

      - name: Upload Web E2E report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-report-web-${{ matrix.project == 'Mobile Chrome' && 'mobile' || 'desktop' }}
          path: |
            e2e-report-web-*/
            test-results/
            playwright-report/
          retention-days: 14

  e2e-summary:
    name: E2E Summary
    runs-on: ubuntu-latest
    needs: [e2e-cli, e2e-web]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-reports

      - name: Generate combined summary
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # CLI results
          CLI_STATUS="${{ needs.e2e-cli.result }}"
          if [[ "$CLI_STATUS" == "success" ]]; then
            echo "- **CLI E2E**: :white_check_mark: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **CLI E2E**: :x: $CLI_STATUS" >> $GITHUB_STEP_SUMMARY
          fi

          # Web results
          WEB_STATUS="${{ needs.e2e-web.result }}"
          if [[ "$WEB_STATUS" == "success" ]]; then
            echo "- **Web E2E**: :white_check_mark: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Web E2E**: :x: $WEB_STATUS" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Reports are available as artifacts on this workflow run." >> $GITHUB_STEP_SUMMARY

      - name: Fail if any test failed
        if: needs.e2e-cli.result == 'failure' || needs.e2e-web.result == 'failure'
        run: exit 1
